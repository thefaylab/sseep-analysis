---
title: "Atlantic mackerel data exploration"
author: "Angelia Miller"
date: "2023-11-22"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(here)
library(sf)
library(patchwork)
library(nationalparkcolors)
source(here("R", "StratMeanFXs_v2.R")) #removed SEASON group for the purposes of the resampling

pal <- park_palette("Badlands")
theme_set(theme_bw())
```

## Data 
```{r data, include= FALSE, message = FALSE}
# full data set 
# complete_data <- readRDS(here("data", "rds", "merged_data_complete.rds")) |> filter(SVSPP == 121) |> mutate(EXPCATCHWT = ifelse(is.na(EXPCATCHWT), 0, EXPCATCHWT))
atlmack_complete <- readRDS(here("data", "rds", "completed_bts_data.rds")) |> filter(SVSPP == 121) |> mutate(EXPCATCHWT = ifelse(is.na(EXPCATCHWT), 0, EXPCATCHWT))

# total biomass of atlantic mackerel in the spring for a given stratum 
atlmack_bio <- readRDS(here("data", "rds", "spatial-filter", "total-biomass_impacted-species.rds")) |> filter(SEASON == "SPRING", SVSPP == 121)

# filtered_data <- readRDS(here("data", "rds", "95filtered_complete_bts.rds")) |> filter(SVSPP == 121) |> mutate(EXPCATCHWT = ifelse(is.na(EXPCATCHWT), 0, EXPCATCHWT))

# read the strata shapefile in to plot the polygons based on proportion and overlay the tow points
strata <- readRDS(here("data", "rds", "active_strata.rds")) 

# wind areas 
wind_areas <- readRDS(here("data", "rds", "wind_areas_062022", "all_wind_areas_Jun2022.rds")) 

coastline <- sf::st_read(dsn = here("gis", "eastern_coast_UTM.shp"))

```

## Summaries 
```{r more data, message = FALSE, include = FALSE}
# full data set 
# raw_data <- read_csv(here("data", "raw-data", "NEFSC_BTS_ALLCATCHES.csv")) |> 
#   filter(SVSPP == 121, EST_YEAR %in% c(2009:2021)) |> 
#   mutate(SVSPP = as.integer(SVSPP), 
#          STATION = as.integer(STATION), 
#          STRATUM = as.integer(STRATUM))
# 
# add_info <- raw_data |> 
#   select(SVSPP, CRUISE6, STATION, STRATUM, BOTTEMP, AREA_SWEPT_WINGS_MEAN_KM2, SEASON)
# 
# filtered_data <- filtered_data |> 
#   left_join(add_info, by = c("SVSPP", "STRATUM", "CRUISE6", "STATION", "SEASON"))
  
```

### Tows
```{r}
atlmack_complete |> 
  filter(!is.na(AVGDEPTH), SEASON == "SPRING") |> 
  group_by(YEAR) |> 
  summarise(length(unique(TOWID)))

full_years <- c(2009:2019, 2021)
```

### Biomass catch rates 
```{r}
atlmack_summary <- atlmack_complete |> 
  filter(!is.na(AVGDEPTH), SEASON == "SPRING", YEAR %in% full_years) |> 
  group_by(EST_YEAR) |>
  summarise(med_wt = median(EXPCATCHWT), 
            max_wt = max(EXPCATCHWT), 
            range_wt = max_wt - med_wt, 
            avg_wt = mean(EXPCATCHWT), 
            sd_wt = sd(EXPCATCHWT), 
            lower = quantile(EXPCATCHWT, 0.05), 
            upper = quantile(EXPCATCHWT, 0.95), 
            tow_ct = length(unique(TOWID)))
atlmack_summary

atlmack_complete |> 
  filter(SEASON == "SPRING", YEAR %in% full_years) |>
  summarise(quantile(EXPCATCHWT, 0.95), 
            quantile(EXPCATCHWT, 0.975), 
            quantile(EXPCATCHWT, 0.99)) 

```

### Catch rates by Depth
```{r depth histogram}
am_spring <- atlmack_complete |> filter(SEASON == "SPRING", !is.na(AVGDEPTH))

ggplot(am_spring |> filter(EXPCATCHWT > 0)) + 
  aes(x = AVGDEPTH, y = EXPCATCHWT)+
  geom_point() + 
  geom_smooth() +
  facet_wrap(~EST_YEAR, scales = "free_y")

ggplot(am_spring) +
  geom_histogram(aes(x = AVGDEPTH), color = "white") 

ggplot(am_spring, aes(x = AVGDEPTH)) + 
  geom_histogram(aes(y = after_stat(count / max(count)*100)), color = "white") + 
  geom_hline(yintercept = 5, color = "red")

# Making a proportional density plot
ggplot(am_spring, aes(AVGDEPTH)) + 
  geom_density(
    aes(
      y = after_stat(count / max(count)*100)
    )
  ) +
  geom_hline(yintercept = 5, color = "red")



```

```{r cumulative biomass by depth}
summary(am_spring$AVGDEPTH)


am_spring$depth_bin <- case_when(am_spring$AVGDEPTH <= 24 ~ 24, 
                                 am_spring$AVGDEPTH > 24 & am_spring$AVGDEPTH <= 36 ~ 36,
                                 am_spring$AVGDEPTH > 36 & am_spring$AVGDEPTH <= 48 ~ 48,
                                 am_spring$AVGDEPTH > 48 & am_spring$AVGDEPTH <= 60 ~ 60,
                                 am_spring$AVGDEPTH > 60 & am_spring$AVGDEPTH <= 72 ~ 72,
                                 am_spring$AVGDEPTH > 72 & am_spring$AVGDEPTH <= 84 ~ 84,
                                 am_spring$AVGDEPTH > 84 & am_spring$AVGDEPTH <= 96 ~ 96,
                                 am_spring$AVGDEPTH > 96 & am_spring$AVGDEPTH <= 108 ~ 108,
                                 am_spring$AVGDEPTH > 108 & am_spring$AVGDEPTH <= 120 ~ 120,
                                 am_spring$AVGDEPTH > 120 & am_spring$AVGDEPTH <= 132 ~ 132,
                                 am_spring$AVGDEPTH > 132 & am_spring$AVGDEPTH <= 144 ~ 144,
                                 am_spring$AVGDEPTH > 144 & am_spring$AVGDEPTH <= 156 ~ 156,
                                 am_spring$AVGDEPTH > 156 & am_spring$AVGDEPTH <= 168 ~ 168,
                                 am_spring$AVGDEPTH > 168 & am_spring$AVGDEPTH <= 180 ~ 180,
                                 am_spring$AVGDEPTH > 180 & am_spring$AVGDEPTH <= 192 ~ 192,
                                 am_spring$AVGDEPTH > 192 & am_spring$AVGDEPTH <= 204 ~ 204,
                                 am_spring$AVGDEPTH > 204 & am_spring$AVGDEPTH <= 216 ~ 216,
                                 am_spring$AVGDEPTH > 216 & am_spring$AVGDEPTH <= 228 ~ 228,
                                 am_spring$AVGDEPTH > 228 & am_spring$AVGDEPTH <= 240 ~ 240,
                                 am_spring$AVGDEPTH > 240 & am_spring$AVGDEPTH <= 252 ~ 252,
                                 am_spring$AVGDEPTH > 252 & am_spring$AVGDEPTH <= 264 ~ 264,
                                 am_spring$AVGDEPTH > 264 & am_spring$AVGDEPTH <= 276 ~ 276,
                                 am_spring$AVGDEPTH > 276 & am_spring$AVGDEPTH <= 288 ~ 288,
                                 am_spring$AVGDEPTH > 288 & am_spring$AVGDEPTH <= 300 ~ 300,
                                 am_spring$AVGDEPTH > 300 & am_spring$AVGDEPTH <= 312 ~ 312,
                                 am_spring$AVGDEPTH > 312 & am_spring$AVGDEPTH <= 324 ~ 324,
                                 am_spring$AVGDEPTH > 324 & am_spring$AVGDEPTH <= 336 ~ 336,
                                 am_spring$AVGDEPTH > 336 & am_spring$AVGDEPTH <= 348 ~ 348,
                                 am_spring$AVGDEPTH > 348 & am_spring$AVGDEPTH <= 360 ~ 360,
                                 am_spring$AVGDEPTH > 360 & am_spring$AVGDEPTH <= 372 ~ 372
                                 )

depth_csum <- am_spring |> 
     group_by(depth_bin) |> 
     summarise(total_bio = sum(EXPCATCHWT), .groups = "drop") |> 
     arrange(desc(total_bio)) |>
     mutate(csum_bio = cumsum(total_bio), 
            csum_prop = csum_bio/max(csum_bio))

lim95 <- max(depth_csum$csum_bio)*0.95
lim99 <- max(depth_csum$csum_bio)*0.99

ggplot(depth_csum) + 
  geom_point(aes(x = fct_reorder(as.character(depth_bin), csum_bio), y = csum_bio)) + 
  ylim(0, NA) + 
  geom_hline(yintercept = lim95, color = "red") +
  geom_hline(yintercept = lim99, color = "blue") +
  labs(x = "Depth (m)", y = "Cumulative Biomass (kg)", title = "AtlMack Cumulative Distribution of Biomass") +
  theme_bw() + 
  theme(axis.text.x = element_text(size = 8, hjust = 0.75, angle = 45, margin = margin(t = 2, r = 10, b = 10, l = 5, unit = "pt")), 
        plot.margin = margin(t = 5, r = 15, b = 5, l = 5))

ggsave("atlmack_csum-bio-by-depth.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 10, height = 6)

depth_csum

```


### Proportion of Zeros
```{r}
atlmack_complete |> 
  filter(!is.na(AVGDEPTH), SEASON == "SPRING", YEAR %in% full_years) |> 
  group_by(EST_YEAR) |>
  summarise(zeros = sum(EXPCATCHWT == 0), 
            prop = zeros/length(unique(TOWID)), .groups = "drop")

atlmack_complete |> 
  filter(!is.na(AVGDEPTH), SEASON == "SPRING", YEAR %in% full_years) |> 
  summarise(zeros = sum(EXPCATCHWT == 0), 
            prop = zeros/length(unique(TOWID)))

atlmack_complete |> 
  filter(!is.na(AVGDEPTH), SEASON == "SPRING", YEAR %in% full_years, EXPCATCHWT == 0) |> ungroup()|>
  #group_by(EST_YEAR) |>
  mutate(towct = length(unique(TOWID))) |> 
  ggplot() + 
  geom_histogram(aes(x = TOWID)) #+ facet_wrap(~YEAR)


    
```



## Cumulative Distribution 
### All the data 
```{r}
atlmack_csum <- atlmack_complete |> 
  filter(SEASON == "SPRING", YEAR %in% full_years) |>
  group_by(STRATUM) |> 
  summarise(total_bio = sum(EXPCATCHWT), .groups = "drop") |>  # sum biomass by groups, and drop groups once calculation is complete 
  arrange(desc(total_bio)) |> 
  mutate(csum_bio = cumsum(total_bio), 
         csum_prop = csum_bio/max(csum_bio))
  
atlmack_csum

  
ggplot(atlmack_csum) + 
  geom_point(aes(x = fct_reorder(as.character(STRATUM), csum_bio), y = csum_bio)) + 
  ylim(0, NA) + 
  geom_hline(yintercept = 0.95*max(atlmack_csum$csum_bio), color = "red") +
  geom_hline(yintercept = 0.99*max(atlmack_csum$csum_bio), color = "blue") +
  labs(x = "Stratum", y = "Cumulative Biomass (kg)", title = "AtlMack Cumulative Distribution of Biomass") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, size = 5))
# ggsave("atlmack_cumul-dist_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 6)

  
```
#### Maps
```{r}
atlmack_strata <- right_join(atlmack_csum, strata, by = "STRATUM") |> # join the filtered data to the strata shapefile; coearces the shapefile into a dataframe 
  na.omit() |> # remove NAs
  st_sf()

ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_strata |> filter(csum_prop <= 0.95), fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    #scale_fill_distiller(palette = palette) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(title = "AtlMack 95% Cumulative Distribution", x = "Longitude", y = "Latitude", fill = "95% Distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank()) 
# ggsave("atlmack_95-dist_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 6)

ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_strata |> filter(csum_prop <= 0.99), fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    #scale_fill_distiller(palette = 8) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(title = "AtlMack 99% Cumulative Distribution", x = "Longitude", y = "Latitude", fill = "99% Distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank()) 
# ggsave("atlmack_99-dist_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 6)

ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_strata, fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    #scale_fill_distiller(palette = 8) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(title = "AtlMack Cumulative Distribution", x = "Longitude", y = "Latitude", fill = "Distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank()) 
```
### Remove Outliers
Removed biomass observations greater than 99th quantile
```{r}
atlmack_csum_no.out <- atlmack_complete |> 
  filter(YEAR %in% full_years) |> 
  filter(EXPCATCHWT <= quantile(EXPCATCHWT, 0.99)) |> 
  group_by(STRATUM) |> 
  summarise(total_bio = sum(EXPCATCHWT), .groups = "drop") |> 
  arrange(desc(total_bio)) |>
  mutate(csum_bio = cumsum(total_bio), 
         csum_prop = csum_bio/max(csum_bio))
  
atlmack_csum_no.out
  
ggplot(atlmack_csum_no.out) + 
  geom_point(aes(x = fct_reorder(as.character(STRATUM), csum_bio), y = csum_bio)) + 
  ylim(0, NA) + 
  geom_hline(yintercept = 0.95*max(atlmack_csum_no.out$csum_bio),color = "red") +
  geom_hline(yintercept = 0.99*max(atlmack_csum_no.out$csum_bio),color = "blue") +
  labs(x = "Stratum", y = "Cumulative Biomass (kg)", title = "AtlMack Cumulative Distribution of Biomass", subtitle = "Biomass observations greater than the 99th quantile were removed from the distribution") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, size = 5))
```
#### Maps
```{r}
atlmack_no.out <- right_join(atlmack_csum_no.out, strata, by = "STRATUM") |> # join the filtered data to the strata shapefile; coearces the shapefile into a dataframe 
  na.omit() |> # remove NAs
  st_sf()


ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_no.out |> filter(csum_prop <= 0.95), fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    #scale_fill_distiller(palette = 8) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(x = "Longitude", y = "Latitude", fill = "95% Distribution", title = "AtlMack 95% Cumulative Distribution", subtitle = "Biomass observations greater than the 99th quantile \nwere removed from the distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank())
# ggsave("atlmack_95-dist_no-out_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 6)

ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_no.out |> filter(csum_prop <= 0.99), fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    #scale_fill_distiller(palette = 8) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(title = "AtlMack 99% Cumulative Distribution", x = "Longitude", y = "Latitude", fill = "99% Distribution", subtitle = "Biomass observations greater than the 99th quantile \nwere removed from the distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank()) 
# ggsave("atlmack_99-dist_no-out_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 6)

ggplot() + 
    geom_sf(data = strata, fill = "white", color = "grey80") + 
    geom_sf(data = coastline, fill = "grey60", color = "black") + 
    geom_sf(data = atlmack_no.out, fill = "#5dc5e9")+ #fill the strata polygons based on the values in the csum_prop column
    scale_fill_distiller(palette = 8) +
    coord_sf() +
    #geom_point(data = x, mapping = aes(DECDEG_BEGLON, DECDEG_BEGLAT, alpha = 0.4), color = "white")
    #facet_wrap(~SEASON) + 
    labs(title = "AtlMack Cumulative Distribution", x = "Longitude", y = "Latitude", fill = "Distribution", subtitle = "Biomass observations greater than the 99th quantile were removed from the distribution") +
    theme_bw() +
    theme(legend.position = "bottom", 
          panel.grid = element_blank()) 
```

## Stratified Mean Abundance Indices
A stratified mean abundance index was derived for Atlantic mackerel for each year of the time series, both in the context of when wind tows were included in the calculation and when wind tows were excluded from the calculation across the full survey footprint. The difference in indices based on the differing calculation are displayed in the plot below. 

### All the data
```{r stratmeans all data}
atlmack_incl.strat <- atlmack_complete|> 
  filter(SEASON == "SPRING", EST_YEAR %in% full_years) |> 
  stratified.mean() |> 
  mutate(data_src = "All data", 
         TYPE = "With Wind Included") 

atlmack_precl.strat <- atlmack_complete|> 
  filter(SEASON == "SPRING", EST_YEAR %in% full_years, AREA == "OUTSIDE") |> 
  stratified.mean() |> 
  mutate(data_src = "All data", 
         TYPE = "With Wind Precluded") 

atlmack_stratmu <- bind_rows(atlmack_incl.strat, atlmack_precl.strat) |>
  group_by(EST_YEAR, TYPE) |> 
  mutate(sdlog = sqrt(log(1+(sqrt(stratvar)/stratmu)^2)), #logistic standard deviation
         lower = qlnorm(0.025, log(stratmu), sdlog), # lower quantile of the logistic normal distribution
         upper = qlnorm(0.975, log(stratmu), sdlog)) |> # upper quantile of the logistic normal distribution
  mutate(sdlog = ifelse(is.nan(sdlog), 0, sdlog), # if sdlog is NaN, replace with 0
         lower = ifelse(is.nan(lower), 0, lower), # if the lower quantile is NaN, replace with 0
         upper = ifelse(is.nan(upper), 0, upper)) # if the upper quantile is NaN, replace with 0

ggplot(atlmack_stratmu) +
  aes(x = as.factor(EST_YEAR), y = stratmu, color = TYPE, shape = TYPE) +
  #geom_point() +
  geom_pointrange(aes(ymin=lower, ymax = upper), position =  position_dodge2(width=0.4)) +
  scale_color_manual(values = pal) +
  #facet_wrap(vars(SEASON), scales = "free_y") +
  labs(x = "YEAR", y = "Stratified Mean (kg/tow)", SEASON = "", TYPE = "", title = "Atlantic mackerel stratified mean abundance index", subtitle = "no outliers have been removed from this calculation") +
  ylim(0,NA) +
  theme_bw() + 
  theme(legend.position="bottom",
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, hjust = -1), 
        axis.title.x = element_text(margin = unit(c(5, 0, 0, 0), "mm")), 
        axis.title.y = element_text(margin = unit(c(0, 3, 0, 0), "mm")))
# ggsave("atlmack_stratmu_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 5)
```

### Remove Outliers 
Abundance indices in both scenarios when you remove the observations of biomass greater than the 99th quantile 
```{r stratmeans remove outliers}
atlmack_incl.strat_no.out <- atlmack_complete|> 
  filter(SEASON == "SPRING", EST_YEAR %in% full_years) |> 
  filter(EXPCATCHWT <= quantile(EXPCATCHWT, 0.99)) |>
  stratified.mean() |> 
  mutate(data_src = "No Outliers", 
         TYPE = "With Wind Included") 

atlmack_precl.strat_no.out <- atlmack_complete |> 
  filter(SEASON == "SPRING", EST_YEAR %in% full_years, AREA == "OUTSIDE") |> 
  filter(EXPCATCHWT <= quantile(EXPCATCHWT, 0.99)) |>
  stratified.mean() |> 
  mutate(data_src = "No Outliers", 
         TYPE = "With Wind Precluded") 

atlmack_stratmu_no.out <- bind_rows(atlmack_incl.strat_no.out, atlmack_precl.strat_no.out) |> 
  mutate(sdlog = sqrt(log(1+(sqrt(stratvar)/stratmu)^2)), #logistic standard deviation
         lower = qlnorm(0.025, log(stratmu), sdlog), # lower quantile of the logistic normal distribution
         upper = qlnorm(0.975, log(stratmu), sdlog), 
         sdlog = ifelse(is.nan(sdlog), 0, sdlog), # if sdlog is NaN, replace with 0
         lower = ifelse(is.nan(lower), 0, lower), # if the lower quantile is NaN, replace with 0
         upper = ifelse(is.nan(upper), 0, upper)) 

ggplot(atlmack_stratmu_no.out) +
  aes(x = as.factor(EST_YEAR), y = stratmu, color = TYPE, shape = TYPE) +
  #geom_point() +
  geom_pointrange(aes(ymin=lower, ymax = upper), position =  position_dodge2(width=0.4)) +
  scale_color_manual(values = pal) +
  labs(x = "YEAR", y = "Stratified Mean (kg/tow)", TYPE = "", title = "Atlantic mackerel stratified mean abundance index", subtitle = "Observations greater than the 99th quantile of biomass have been removed from this calculation") +
  ylim(0,NA) +
  theme_bw() + 
  theme(legend.position="bottom",
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, hjust = -1), 
        axis.title.x = element_text(margin = unit(c(5, 0, 0, 0), "mm")), 
        axis.title.y = element_text(margin = unit(c(0, 3, 0, 0), "mm")))
# ggsave("atlmack_stratmu_no.out_plot.png", last_plot(), device = "png", here("outputs", "atlmackerel"), width = 8, height = 5)

```

## Compare Indices
### All the data 
Calculate the mean percent relative difference between the status quo and preclusion indices 
```{r}
atlmack_mudiff <- atlmack_stratmu |> 
  filter(EST_YEAR %in% c(2014:2019)) |> #filter for recent 5 years, skipping 2020
  #mutate(log_mu = log(stratmu)) |>
  arrange(desc(stratmu)) |>
  group_by(SVSPP, EST_YEAR) |> #, 
  #summarize(sq_diff = (exp(diff(log(stratmu)))-1)^2, .groups = "drop") |>
  summarise(diff_mu = diff(stratmu)) |>
  arrange(desc(diff_mu)) |>
  mutate(exp_mu = (exp(diff_mu))-1) |>
  arrange(desc(exp_mu)) |>
  mutate(sq_diff = exp_mu^2) |>
  arrange(desc(sq_diff))|>
  ungroup()|>
  #summarize(sq_diff = (diff(stratmu))^2, .groups = "drop") |> # calculate the relative differences and square them; drop the groups for further analysis
  #group_by(SVSPP, SEASON) |>
  summarize(mudiff = mean(sq_diff), .groups = "drop") |> # calculate the average; drop the grouping factor 
  mutate(mudiff = sqrt(mudiff)*100)
```

### Remove Outliers 
Calculate the mean percent relative difference between the status quo and preclusion indices when outliers have been removed 
```{r mudiff compare}
atlmack_mudiff_no.out <- atlmack_stratmu_no.out |> 
  #mutate(stratmu = ifelse(stratmu==0, 1, stratmu)) |>
  filter(EST_YEAR %in% c(2014:2019)) |> #filter for recent 5 years, skipping 2020
  #mutate(log_mu = log(stratmu)) |>
  arrange(desc(stratmu)) |>
  group_by(SVSPP, EST_YEAR) |> #, 
  #summarize(sq_diff = (exp(diff(log(stratmu)))-1)^2, .groups = "drop") |>
  summarise(diff_mu = diff(stratmu)) |>
  arrange(desc(diff_mu)) |>
  mutate(exp_mu = (exp(diff_mu))-1) |>
  arrange(desc(exp_mu)) |>
  mutate(sq_diff = exp_mu^2) |>
  arrange(desc(sq_diff))|>
  ungroup()|>
  #summarize(sq_diff = (diff(stratmu))^2, .groups = "drop") |> # calculate the relative differences and square them; drop the groups for further analysis
  #group_by(SVSPP, SEASON) |>
  summarize(mudiff = mean(sq_diff), .groups = "drop") |> # calculate the average; drop the grouping factor 
  mutate(mudiff = sqrt(mudiff)*100) 

atlmack_mudiff_no.out
atlmack_mudiff
```

### Compare Status Quo Indices 
Calculate the mean percent relative difference between the status quo index when no outliers are removed and when outliers are removed  
(e.g How different are the indices with all data included when you remove the outliers?)
```{r}
atlmack_incl.mu <- bind_rows(atlmack_incl.strat, atlmack_incl.strat_no.out)

atlmack_incl.mu_diff <- atlmack_incl.mu |> 
  #mutate(stratmu = ifelse(stratmu==0, 1, stratmu)) |>
  filter(EST_YEAR %in% c(2014:2019)) |> #filter for recent 5 years, skipping 2020
  #mutate(log_mu = log(stratmu)) |>
  arrange(desc(stratmu)) |>
  group_by(EST_YEAR) |> #, 
  #summarize(sq_diff = (exp(diff(log(stratmu)))-1)^2, .groups = "drop") |>
  summarise(diff_mu = diff(stratmu)) |>
  arrange(desc(diff_mu)) |>
  mutate(exp_mu = (exp(diff_mu))-1) |>
  arrange(desc(exp_mu)) |>
  mutate(sq_diff = exp_mu^2) |>
  arrange(desc(sq_diff))|>
  ungroup()|>
  #summarize(sq_diff = (diff(stratmu))^2, .groups = "drop") |> # calculate the relative differences and square them; drop the groups for further analysis
  #group_by(SVSPP, SEASON) |>
  summarize(mudiff = mean(sq_diff), .groups = "drop") |> # calculate the average; drop the grouping factor 
  mutate(mudiff = sqrt(mudiff)*100) 

atlmack_incl.mu_diff
```


```{r}

```







