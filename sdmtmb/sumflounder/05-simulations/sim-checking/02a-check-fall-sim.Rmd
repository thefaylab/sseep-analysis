---
title: "Summer flounder fall simulation check"
author: "Angelia Miller"
date: "2024-01-04"
output: word_document
---

## Objective 
* simulate 1 year and replicate  



```{r load packages}
# library(stringr)
# library(sf)
# library(patchwork)
library(here)
suppressPackageStartupMessages(library(tidyverse))
library(sdmTMB) 
source(here("R", "StratMeanFXs_v2.R"))

sumflounder.dat <- here("sdmtmb", "sumflounder", "data")
sim.check <- here("sdmtmb", "sumflounder", "data", "simulations", "sim-checking")
```

Model fitting data
```{r}
sf_fall <- readRDS(here(sumflounder.dat, "sumflounder_fall.rds"))
fall_mesh <- readRDS(here(sumflounder.dat, "fall_mesh.rds"))
```

Data wrangle
```{r data}
# read in fall model 
# fall_mod <- readRDS(here(sumflounder.dat, "fall_mod.rds"))
# fall_moddat <- fall_mod$data |> 
#   mutate(EST_YEAR = YEAR, 
#          AREA = as.character(AREA))

# pull polynomial coefficients from fall model fit
fall_x_mat <- poly(sf_fall$AVGDEPTH, 2)
fall_depth_coefs <- attr(fall_x_mat,"coefs")
# saveRDS(fall_x_mat, here(sim.check, "fall_depth_matrix.rds"))
# saveRDS(fall_depth_coefs, here(sim.check, "fall_depth_coefs.rds"))
fall_depth_coefs
```


Re-fit the model 
```{r}
fall_mod <- sdmTMB(EXPCATCHWT ~ poly(AVGDEPTH, 2, coefs = fall_depth_coefs) + 
                    as.factor(EST_YEAR) + 
                    as.factor(AREA) - 1,
                  data = sf_fall,
                  mesh = fall_mesh,
                  family = tweedie(link = "log"), 
                  spatial = "on", 
                  time = "EST_YEAR",
                  spatiotemporal = "IID",
                  control = sdmTMBcontrol(newton_loops = 1)) 

sanity(fall_mod)
#saveRDS(fall_mod, here(sim.check, "fall_mod.rds"))
```


```{r}
coefs <- tidy(fall_mod)
ran_pars <- tidy(fall_mod, "ran_pars")

fall_depth_coefs
coefs
ran_pars
```


Generate predictions
```{r preds}
mod_preds <- predict(fall_mod)
# saveRDS(mod_preds, here(sim.check, "fall_predictions.rds"))

str(mod_preds)
```


Select locations and predictions from one year of past data to simulate values of biomass
```{r resample}
set.seed(1211)
year <- sample(unique(sf_fall$EST_YEAR), size = 1)
# saveRDS(year, here(sim.check, "fall_resample_year.rds"))
set.seed(131)
resample <- mod_preds |>
  # mutate(EST_YEAR = YEAR) |>
  filter(EST_YEAR == year) |> 
  select(X, Y, STATION, STRATUM, CRUISE6, AVGDEPTH, EST_YEAR, AREA, omega_s, est, est_non_rf) |> 
  mutate(EST_YEAR = 1) |>
  rename(fix_omegas = omega_s) |> 
  slice_sample(n = 5, replace = FALSE)
# saveRDS(resample, here(sim.check, "fall_resampled_data.rds")) 
resample

mesh <- make_mesh(resample, xy_cols = c("X", "Y"), cutoff = 10, seed = 42)
# saveRDS(mesh, here(sim.check, "fall_mesh.rds"))
plot(mesh)
```


Simulate without any random effects 
* expected: eta and fix_omegas should match
```{r sim1}
simdat1 <- sdmTMB_simulate(
    formula = ~1 +
      #poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      #EST_YEAR +
      #as.factor(AREA) +
      fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "iid",
    B = c(0, 1), 
    range = 0.5, 
    sigma_O = 0,
    sigma_E = 0, 
    phi = 0.1,
    tweedie_p = 1.5,
    seed = 2)
simdat1
# saveRDS(simdat1, here(sim.check, "fall_simdat1.rds"))
```
* `eta` = `fix_omegas` : TRUE 


Test effect of area coefficient
```{r sim2}
b <- c(0, coefs$estimate[14])
simdat2 <- sdmTMB_simulate(
    formula = ~1 +
      #poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      #EST_YEAR +
      as.factor(AREA),# +
      #fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "iid",
    B = b, 
    range = 0.5, 
    sigma_O = 0,
    sigma_E = 0, 
    phi = 0.1, 
    tweedie_p = 1.5,
    seed = 2)
simdat2

# saveRDS(simdat2, here(sim.check, "fall_simdat2.rds"))
```
* `eta` = wind coefficient x as.factor(AREA)WIND : TRUE


Test effect of depth coefficients 
```{r sim3}
b <- c(0, coefs$estimate[1:2])
simdat3 <- sdmTMB_simulate(
    formula = ~1 +
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs),# +
      #EST_YEAR +
      #as.factor(AREA) +
      #fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "iid",
    B = b, 
    range = 0.5, 
    sigma_O = 0,
    sigma_E = 0, 
    phi = 0.1, 
    tweedie_p = 1.5,
    seed = 2)
simdat3

# saveRDS(simdat3, here(sim.check, "fall_simdat3.rds"))
```

* `eta` = (depth coefficient1 x simulated depth val1) + (depth coefficient2 x simulated depth val2): TRUE

Test effect of year coefficient
```{r sim4}
b <- c(0, coefs$estimate[10])
simdat4 <- sdmTMB_simulate(
    formula = ~1 +
      #poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      EST_YEAR,# +
      #as.factor(AREA) +
      #fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "iid",
    B = b,
    range = 0.5, 
    sigma_O = 0,
    sigma_E = 0, 
    phi = 0.1, 
    tweedie_p = 1.5,
    seed = 2)
simdat4

# saveRDS(simdat4, here(sim.check, "fall_simdat4.rds"))
```

* `eta` = 2016 coefficient x EST_YEAR : TRUE


Add in all covariates to linear predictor and their respective coefficients 
```{r sim5}
b <- c(0, coefs$estimate[1:2], coefs$estimate[10], coefs$estimate[14])

simdat5 <- sdmTMB_simulate(
    formula = ~1 +
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      EST_YEAR +
      as.factor(AREA),#+
      #fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    #time = "EST_YEAR",
    #spatiotemporal = "iid",
    B = b, 
    range = 0.5, 
    sigma_O = 0,
    sigma_E = 0, 
    phi = 0.1, 
    tweedie_p = 1.5,
    seed = 2)
simdat5

simdat5 |>  
  right_join(resample, by = c("X", "Y", "EST_YEAR")) |>
  select(!c(STATION, STRATUM, CRUISE6, AVGDEPTH, AREA)) 

# saveRDS(simdat5, here(sim.check, "fall_simdat5.rds"))

```
* `eta` = `est_non_rf`: TRUE. 
* therefore, sdmtmb_simulate is simulating the same values as the model estimates in the base scenario and we can be sure that any treatment will be reflected in the simulated values. 


Simulate the increase scenario without spatiotemporal random effects
```{r sim increase}
b <- c(0, coefs$estimate[1:2], coefs$estimate[10], (coefs$estimate[14]+log(2)), 1)

simdat6 <- sdmTMB_simulate(
    formula = ~1 +
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      EST_YEAR +
      as.factor(AREA) +
      fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "IID",
    B = b,
    range = ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = 0,
    phi = ran_pars$estimate[2],
    tweedie_p = ran_pars$estimate[5],
    seed = 2)
simdat6

# saveRDS(simdat6, here(sim.check, "fall_simdat6.rds"))
```
* `eta` = (depth coefficient1 x simulated depth val1) + (depth coefficient2 x simulated depth val2) + (2016 coefficient x EST_YEAR) + ((wind coefficient + log(2)) x as.factor(AREA)WIND) + fix_omegas : TRUE
* therefore, we can be sure when factoring in treatment and spatiotemporal effects, any deviation from the `eta` value here in simulated biomass is due to the random effects. 


Simulate the increase scenario without spatiotemporal random effects
```{r sim decrease}
b <- c(0, coefs$estimate[1:2], coefs$estimate[10], (coefs$estimate[14]-log(2)), 1)

simdat7 <- sdmTMB_simulate(
    formula = ~1 +
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      EST_YEAR +
      as.factor(AREA) +
      fix_omegas,
    data = resample,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    #spatiotemporal = "IID",
    B = b,
    range = ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = 0,
    phi = ran_pars$estimate[2],
    tweedie_p = ran_pars$estimate[5],
    seed = 2)
simdat7

# saveRDS(simdat7, here(sim.check, "fall_simdat7.rds"))
```
* `eta` = (depth coefficient1 x simulated depth val1) + (depth coefficient2 x simulated depth val2) + (2016 coefficient x EST_YEAR) + ((wind coefficient - log(2)) x as.factor(AREA)WIND) + fix_omegas : TRUE
* therefore, we can be sure when factoring in treatment and spatiotemporal effects, any deviation from the `eta` value here in simulated biomass is due to the random effects. 


```{r}
# b <- c(0, coefs$estimate[10], coefs$estimate[14], 1) #save coefficients in object
# 
# simdat6 <- sdmTMB_simulate(
#     formula = ~1 +
#       #poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
#       EST_YEAR + # added year coefficient
#       as.factor(AREA) +
#       fix_omegas,
#     data = resample,
#     mesh = mesh,
#     family = tweedie(),
#     #spatial = "on",
#     time = "EST_YEAR",
#     spatiotemporal = "IID",
#     B = b, # call coefficient here with new value added here
#     range = ran_pars$estimate[1], 
#     sigma_O = 0,
#     sigma_E = 0, 
#     phi = ran_pars$estimate[2], 
#     tweedie_p = ran_pars$estimate[5],
#     seed = 2)
# head(simdat6)

# saveRDS(simdat6, here(sim.check, "simdat6.rds"))
# 
# simdat6 |>  
#   select(!EST_YEAR) |> 
#   right_join(mod_preds, by = c("X", "Y")) |> 
#   select(X, Y, mu, eta, observed, est, est_non_rf, est_rf, fix_omegas)
```


 
```{r}
# b2 <- c(0, coefs$estimate[1:2], coefs$estimate[10], coefs$estimate[14], 1) # add poly(depth,2) coeficients
# 
# simdat7 <- sdmTMB_simulate(
#     formula = ~1 +
#       poly(AVGDEPTH, 2, coefs = fall_depth_coefs) + #add depth to predictor
#       EST_YEAR +
#       as.factor(AREA) +
#       fix_omegas,
#     data = resample,
#     mesh = mesh,
#     family = tweedie(),
#     #spatial = "on",
#     time = "EST_YEAR",
#     spatiotemporal = "IID",
#     B = b2, 
#     range = ran_pars$estimate[1], 
#     sigma_O = 0,
#     sigma_E = 0, 
#     phi = ran_pars$estimate[2], 
#     tweedie_p = ran_pars$estimate[5],
#     seed = 2)
# head(simdat7)
# 
# simdat7 |> 
#   select(!EST_YEAR) |>
#   right_join(mod_preds, by = c("X", "Y")) |> 
#   select(X, Y, mu, eta, observed, est, est_non_rf, est_rf, fix_omegas)|> head(n = 10)

# plot(mod_preds$AVGDEPTH, mod_preds$est_non_rf)
# plot(resample$AVGDEPTH, simdat7$`poly(AVGDEPTH, 2, coefs = fall_depth_coefs)1`)
# plot(fall_moddat$AVGDEPTH, fall_x_mat[,1])

```


```{r }

```

