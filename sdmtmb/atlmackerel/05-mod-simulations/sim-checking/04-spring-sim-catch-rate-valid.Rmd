---
title: "Validate spring Atlantic mackerel catch rates"
author: "Angelia Miller"
date: "2024-01-10"
output: word_document
---

## Objective 
simulate one year and 500 replicates of the two treatments and control in one wind-overlapped strata
* plot the distribution of catch rates for each scenario 

```{r load packages}
# library(stringr)
# library(sf)
library(patchwork)
library(here)
suppressPackageStartupMessages(library(tidyverse))
library(sdmTMB)
# source(here("R", "StratMeanFXs_v2.R"))

atlmackerel.dat <- here("sdmtmb", "atlmackerel", "data")
sim.check <- here("sdmtmb", "atlmackerel", "data", "simulations", "sim-checking")
sim.check.plots <- here("sdmtmb", "atlmackerel", "plots", "simulations", "sim-checking")
```

### Data set up 
Load in the model fitting data, fitted model, and the model predictions 
```{r load data}
# model fitting data 
atlmackerel_spring <- readRDS(here(atlmackerel.dat, "atlmackerel_spring_rm200.rds"))

# model fitting mesh 
#mesh <- readRDS(here(atlmackerel.dat, "spring_mesh.rds"))

# polynomial coefficients from spring model fit extracted in "02-check-spring-sim.Rmd"
spring_depth_coefs <- readRDS(here(sim.check, "depth_coefs.rds"))

# spring summer flounder model 
spring_mod <- readRDS(here(atlmackerel.dat, "spring_mod.rds"))

# spring model predictions 
spring_preds <- readRDS(here(atlmackerel.dat, "atlmackerel_mod_preds.rds")) |> 
  select(X, Y, STATION, CRUISE6, STRATUM, omega_s) |> 
  rename(fix_omegas = omega_s)


```

Generate a random set of numbers for the number of iterations that will be produced in the simulation to use as the set seed argument for reproducibility. 
Then find the number of wind tows in each strata and year and the total proportion those tows make up of the overall tows observed in that year and strata. From here we want to select a strata and year that have ~50% proportion of wind tows, and where the observations of biomass in those tows are of equal magnitude to those observations of biomass that occurred in outside tows. 
```{r number generation}
set.seed(72346)

# generate 3000 random numbers and sample for 500 to set seed with each iteration of sdmTMB_simulate for reproducibility
seed.num.gen <- round(rnorm(3000, mean = 1305700, sd = 10000), 0)
seed.num <- sample(seed.num.gen, size = 500, replace = FALSE)
# length(which(duplicated(seed.num) == TRUE))

# identify which year and stratum has the most wind tows
wind_tows <- atlmackerel_spring |> 
  filter(AREA == "WIND") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
outside_tows <- atlmackerel_spring |> 
  filter(AREA == "OUTSIDE") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
left_join(outside_tows, wind_tows, by = c("EST_YEAR", "STRATUM")) |> janitor::clean_names() |> 
  mutate(prop = count_y / (count_x + count_y)) |> 
  arrange(desc(prop))

```
Set the year and strata to filter the model fitted data and predictions by to create a new dataset of locations that will be used to simulate values of biomass at. 
```{r data wrangle}
year <- 2010
strat <- 1650

# join prediction data to model fitting data to add predicted spatial estimate for data simulation
atlmackerel_spring <- atlmackerel_spring |> 
  left_join(spring_preds, by = c("X", "Y", "STATION", "STRATUM", "CRUISE6")) |> 
  filter(EST_YEAR == year, STRATUM == strat) |> 
  mutate(EST_YEAR = 1)


# atlmackerel_spring_info <- atlmackerel_spring |>
#   select(X, Y, EST_YEAR, STRATUM, CRUISE6, STATION, AREA, AREA_CODE, SEASON)

# mesh for simulating
mesh <- make_mesh(atlmackerel_spring, xy_cols = c("X", "Y"), cutoff = 20)

# pull main effect parameters from spring model fit
spring_coefs <- tidy(spring_mod) 

# pull random effect parameters from spring model fit
spring_ran_pars <- tidy(spring_mod, "ran_pars")

spring_coefs
spring_ran_pars

```


## Simulate Scenarios 
Set the b argument by extracting the coefficients for the depth effects, the selected year, and the area effect with and without the intended treatment effects. Remove the intercept value by setting its coefficient to 0, and fix the predicted spatial effect from the model by setting its coefficient to 1 and removing the `sigma_O` argument from the simulation.

### Base 
```{r sim base}
b <-  c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[6],
       0, 1)

spring.base <- map2(1:500, seed.num, ~sdmTMB_simulate(
    formula = ~1 + poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      EST_YEAR +
      as.factor(AREA) +
      fix_omegas,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], 
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.base)
# saveRDS(spring.base, here(sim.check, "spring_base-500sims.rds"))


```

### Enhanced
```{r sim increase}
b <- c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[6],
       log(2), 1)

spring.inc <- map2(1:500, seed.num, ~sdmTMB_simulate(
    formula = ~1 + poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      EST_YEAR +
      as.factor(AREA) +
      fix_omegas,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.inc)
# saveRDS(spring.inc, here(sim.check, "spring_inc-500sim.rds"))
```

### Reduced
```{r sim decrease}
b <- c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[6],
       (-log(2)), 1)

spring.dec <- map2(1:500, seed.num, ~sdmTMB_simulate(
    formula = ~1 + poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      EST_YEAR +
      as.factor(AREA) +
      fix_omegas,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.dec)
# saveRDS(spring.dec, here(sim.check, "spring_dec-500sim.rds"))
```



## Calculate Statistics
The mean catch rate for each productivity scenario simulation and the absolute percent difference between survey effort reduction scenarios

### Base
```{r}
# create one large dataframe and add a sim column 
spring.base.df <- map(spring.base, ~janitor::clean_names(.)) |> 
  map2_dfr(1:500, ~mutate(.x, sim = .y))

# calculate the "status quo" scenario
spring_base_ww <- spring.base.df |> 
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Baseline")

# calculate the "precluded" scenario
spring_base_wow <- spring.base.df |> 
  filter(as_factor_area_wind == 0) |> #outside areas
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Baseline")

# bind the scenarios to calculate the absolute percent difference 
base_diff <- left_join(spring_base_ww, spring_base_wow, by = c("sim", "scenario")) |>
  janitor::clean_names() |>
  group_by(sim) |> #, est_year) |>
  summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
            abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
  mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
         abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
         scenario = "Baseline", 
         season = "Spring")

# saveRDS(spring_base_ww, here(sim.check, "spring_base_ww-500sim.rds"))
# saveRDS(spring_base_wow, here(sim.check, "spring_base_wow-500sim.rds"))
# saveRDS(base_diff, here(sim.check, "spring_base_diff-500sim.rds"))

```

### Enhanced
```{r}
# create one large dataframe and add a sim column 
spring.inc.df <- map(spring.inc, ~janitor::clean_names(.)) |> 
  map2_dfr(1:500, ~mutate(.x, sim = .y))

# calculate the "status quo" scenario
spring_inc_ww <- spring.inc.df |> 
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Enhanced", 
         cv = ifelse(is.nan(cv), 0, cv))

# calculate the "precluded" scenario
spring_inc_wow <- spring.inc.df |> 
  filter(as_factor_area_wind == 0) |> #outside areas
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Enhanced", 
         cv = ifelse(is.nan(cv), 0, cv))

# bind the scenarios to calculate the absolute percent difference 
inc_diff <- left_join(spring_inc_ww, spring_inc_wow, by = c("sim", "scenario")) |>
  janitor::clean_names() |>
  group_by(sim) |> #, est_year) |>
  summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
            abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
  mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
         abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
         scenario = "Enhanced", 
         season = "Spring")

# saveRDS(spring_inc_ww, here(sim.check, "spring_inc_ww-500sim.rds"))
# saveRDS(spring_inc_wow, here(sim.check, "spring_inc_wow-500sim.rds"))
# saveRDS(inc_diff, here(sim.check, "spring_inc_diff-500sim.rds"))

```

### Reduced
```{r}
# create one large dataframe and add a sim column 
spring.dec.df <- map(spring.dec, ~janitor::clean_names(.)) |> 
  map2_dfr(1:500, ~mutate(.x, sim = .y))

# calculate the "status quo" scenario
spring_dec_ww <- spring.dec.df |> 
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Reduced", 
         cv = ifelse(is.nan(cv), 0, cv))

# calculate the "precluded" scenario
spring_dec_wow <- spring.dec.df |> 
  filter(as_factor_area_wind == 0) |> #outside areas
  group_by(sim) |> 
  summarise(mu = mean(observed), 
            var = var(observed), 
            cv = sqrt(var)/mu) |> 
  mutate(scenario = "Reduced", 
         cv = ifelse(is.nan(cv), 0, cv))#, 
         #cv = ifelse(is.nan(cv), 0, cv))

# bind the scenarios to calculate the absolute percent difference 
dec_diff <- left_join(spring_dec_ww, spring_dec_wow, by = c("sim", "scenario")) |>
  janitor::clean_names() |>
  group_by(sim) |> #, est_year) |>
  summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
            abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
  mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
         abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
         scenario = "Reduced", 
         season = "Spring")

# saveRDS(spring_dec_ww, here(sim.check, "spring_dec_ww-500sim.rds"))
# saveRDS(spring_dec_wow, here(sim.check, "spring_dec_wow-500sim.rds"))
# saveRDS(dec_diff, here(sim.check, "spring_dec_diff-500sim.rds"))

```

## Plot distribution
### Differences in the means 
```{r}
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
bind_rows(base_diff, inc_diff, dec_diff) |> 
  ggplot() + 
  geom_boxplot(aes(x = as.factor(scenario), y = abs_diff_mu)) + 
  labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in means between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
  facet_wrap(~season) +
  theme_bw()

# to extract exact median values plotted in the boxplot
median(base_diff$abs_diff_mu)
median(inc_diff$abs_diff_mu)
median(dec_diff$abs_diff_mu)


# ggsave("spring_500sim_mudiff-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)

```

### Differences in the cvs 
```{r}
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
bind_rows(base_diff, inc_diff, dec_diff) |> 
  ggplot() + 
  geom_boxplot(aes(x = as.factor(scenario), y = abs_diff_cv)) + 
  labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in the CVs between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
  facet_wrap(~season) +
  theme_bw()

# to extract exact median values plotted in the boxplot
median(base_diff$abs_diff_cv)
median(inc_diff$abs_diff_cv)
median(dec_diff$abs_diff_cv)


# ggsave("spring_500sim_cv-diff-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)

```
