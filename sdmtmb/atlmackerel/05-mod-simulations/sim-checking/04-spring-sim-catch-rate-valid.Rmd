---
title: "Validate spring Atlantic mackerel catch rates"
author: "Angelia Miller"
date: "2024-01-10"
output: word_document
---

## Objective 
simulate one year and 500 replicates of the two treatments and control in one wind-overlapped strata
* plot the distribution of catch rates for each scenario 

```{r load packages}
# library(stringr)
# library(sf)
library(patchwork)
library(here)
suppressPackageStartupMessages(library(tidyverse))
library(sdmTMB)
theme_set(theme_bw())
library(nationalparkcolors)
# source(here("R", "StratMeanFXs_v2.R"))

pal <- park_palette("Badlands")
atlmackerel.dat <- here("sdmtmb", "atlmackerel", "data")
sim.check <- here("sdmtmb", "atlmackerel", "data", "simulations", "sim-checking")
sim.check.plots <- here("sdmtmb", "atlmackerel", "plots", "simulations", "sim-checking")
```

### Data set up 
Load in the model fitting data, fitted model, and the model predictions 
```{r load data}
# model fitting data 
atlmackerel_spring <- readRDS(here(atlmackerel.dat, "atlmackerel_spring_rm200.rds")) |> 
  mutate(EST_YEAR = as.integer(as.character(EST_YEAR)), 
         AREA = as.character(AREA))

# model fitting mesh 
#mesh <- readRDS(here(atlmackerel.dat, "spring_mesh.rds"))

# polynomial coefficients from spring model fit extracted in "02-check-spring-sim.Rmd"
spring_depth_coefs <- readRDS(here(sim.check, "depth_coefs.rds"))

# spring summer flounder model 
spring_mod <- readRDS(here(atlmackerel.dat, "spring_mod.rds"))

# spring model predictions 
spring_preds <- readRDS(here(atlmackerel.dat, "atlmackerel_mod_preds.rds")) |> 
  select(X, Y, STATION, CRUISE6, STRATUM, omega_s) |> 
  rename(fix_omegas = omega_s)


```

Generate a random set of numbers for the number of iterations that will be produced in the simulation to use as the set seed argument for reproducibility. 
Then find the number of wind tows in each strata and year and the total proportion those tows make up of the overall tows observed in that year and strata. From here we want to select a strata and year that have ~50% proportion of wind tows, and where the observations of biomass in those tows are of equal magnitude to those observations of biomass that occurred in outside tows. 
```{r number generation}
set.seed(72346)

# generate 3000 random numbers and sample for 500 to set seed with each iteration of sdmTMB_simulate for reproducibility
seed.num.gen <- round(rnorm(3000, mean = 1305700, sd = 10000), 0)
seed.num <- sample(seed.num.gen, size = 100, replace = FALSE)
# length(which(duplicated(seed.num) == TRUE))

# identify which year and stratum has the most wind tows
wind_tows <- atlmackerel_spring |> 
  filter(AREA == "WIND") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
outside_tows <- atlmackerel_spring |> 
  filter(AREA == "OUTSIDE") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
left_join(outside_tows, wind_tows, by = c("EST_YEAR", "STRATUM")) |> janitor::clean_names() |> 
  mutate(prop = count_y / (count_x + count_y)) |> 
  arrange(desc(prop))

```
Set the year and strata to filter the model fitted data and predictions by to create a new dataset of locations that will be used to simulate values of biomass at. 
```{r data wrangle}
# join prediction data to model fitting data to add predicted spatial estimate for data simulation
atlmackerel_spring <- atlmackerel_spring |> 
  left_join(spring_preds, by = c("X", "Y", "STATION", "STRATUM", "CRUISE6")) #|> 
  # filter(EST_YEAR == year, STRATUM == strat) |> 
  # mutate(EST_YEAR = 1)


atlmackerel_spring_info <- atlmackerel_spring |>
  select(X, Y, EST_YEAR, STRATUM, CRUISE6, STATION, AREA, AREA_CODE, SEASON, AVGDEPTH) |> 
  mutate(AREA_CODE = ifelse(AREA == "OUTSIDE", 0, AREA_CODE))


# mesh for simulating
mesh <- make_mesh(atlmackerel_spring, xy_cols = c("X", "Y"), cutoff = 20)

# pull main effect parameters from spring model fit
spring_coefs <- tidy(spring_mod) 

# pull random effect parameters from spring model fit
spring_ran_pars <- tidy(spring_mod, "ran_pars")

spring_coefs
spring_ran_pars

```


## Simulate Scenarios 
Set the b argument by extracting the coefficients for the depth effects, the selected year, and the area effect with and without the intended treatment effects. Remove the intercept value by setting its coefficient to 0, and fix the predicted spatial effect from the model by setting its coefficient to 1 and removing the `sigma_O` argument from the simulation.

### Base 
```{r sim base}
# b <-  c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[5],
#        0, 1)
b <- c(spring_coefs$estimate, 0, 1)

spring.base <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1 + 
      poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], 
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.base)
# saveRDS(spring.base, here(sim.check, "spring_base-100sims.rds"))


```

### Enhanced
```{r sim increase}
# b <- c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[5],
#        log(2), 1)
b <- c(spring_coefs$estimate, log(2), 1)

spring.inc <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1 + 
      poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.inc)
# saveRDS(spring.inc, here(sim.check, "spring_inc-100sims.rds"))
```

### Reduced
```{r sim decrease}
# b <- c(0, spring_coefs$estimate[1:4], spring_coefs$estimate[5],
       # (-log(2)), 1)
b <- c(spring_coefs$estimate, -log(2), 1)

spring.dec <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1 + 
      poly(AVGDEPTH, 4, coefs = spring_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = atlmackerel_spring,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = spring_ran_pars$estimate[1], # added range parameter
    sigma_O = 0,
    sigma_E = spring_ran_pars$estimate[4],
    phi = spring_ran_pars$estimate[2],
    tweedie_p = spring_ran_pars$estimate[5],
    seed = .y)
)

head(spring.dec)
# saveRDS(spring.dec, here(sim.check, "spring_dec-100sim.rds"))
```



## Data wrangle 
Create one large dataframe from each productivity simulation based on simulated iteration. 

```{r}
# year and strata to focus on 
year <- 2009
strat <- 1690

# Baseline
spring.base.df <- map(spring.base, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Baseline", 
         season = "Spring") |> 
  left_join(atlmackerel_spring_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)


# Enhanced 
spring.inc.df <- map(spring.inc, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Enhanced", 
         season = "Spring") |> 
  left_join(atlmackerel_spring_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)


# Reduced
spring.dec.df <- map(spring.dec, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Reduced", 
         season = "Spring") |> 
  left_join(atlmackerel_spring_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)


```

Proportion of Zeros 
```{r}
# Baseline
base_zeros <- spring.base.df |>
  group_by(scenario, sim) |>
  nest() |>
  mutate(zero = map(data, ~filter(., observed == 0) |> nrow()),
         total = map(data, ~nrow(.))) |>
  select(!data) |>
  unnest(cols = c(zero, total)) |>
  summarise(prop = round((zero/total)*100, 0))

# Enhanced 
inc_zeros <- spring.inc.df |>
  group_by(scenario, sim) |>
  nest() |>
  mutate(zero = map(data, ~filter(., observed == 0) |> nrow()),
         total = map(data, ~nrow(.))) |>
  select(!data) |>
  unnest(cols = c(zero, total)) |>
  summarise(prop = round((zero/total)*100, 0))


# Reduced 
dec_zeros <- spring.dec.df |>
  group_by(scenario, sim) |>
  nest() |>
  mutate(zero = map(data, ~filter(., observed == 0) |> nrow()),
         total = map(data, ~nrow(.))) |>
  select(!data) |>
  unnest(cols = c(zero, total)) |>
  summarise(prop = round((zero/total)*100, 0))


bind_rows(base_zeros, inc_zeros, dec_zeros) |> 
  ggplot() + 
  aes(x = as.factor(scenario), y = prop) + 
  geom_boxplot() + 
  labs(x = "Productivity scenario", y = "Proportion of zeros (%)", subtitle = "Distribution of proportion of simulated zeros")

# ggsave("prop_zeros.png", last_plot(), device = "png", here(sim.check.plots), width = 8, height = 6)


```



## Plot distribution of catch rates 
```{r}
bind_rows(spring.base.df, spring.inc.df, spring.dec.df) |> 
  #filter(observed > 0) |> 
    ggplot() + 
    geom_col(aes(x = as.factor(scenario), y = observed, fill = as.factor(as_factor_area_wind)), position = position_dodge(width = 0.3), width = 0.25) + 
  scale_fill_manual(values = pal, breaks = c(0, 1), labels = c("Outside Wind", "Inside Wind")) +
  facet_wrap(~season) + 
  labs(x = "Productivity scenario", y = "Simulated values of biomass (kg)", subtitle = str_c("Distribution of simulated values of Atlantic mackerel biomass for each productivity scenario observed in\nstratum", strat, "in", year, sep = " "), fill = "Area of catch\nrate occurrence") + 
  theme(legend.position = "bottom")
  
# ggsave("spring_500sim_catchrate-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)

bind_rows(spring.base.df, spring.inc.df, spring.dec.df) |>
  #filter(observed > 0) |> 
     ggplot() + 
  aes(x = observed, fill = AREA)+
     geom_histogram() + 
  # geom_dotplot(binwidth = 0.02)+
  #geom_bar() + scale_x_binned() + 
   scale_fill_manual(values = pal) +
   facet_grid(cols = vars(scenario), rows = vars(AREA)) + 
   labs(x = "Catch rate (kg/tow)", y = "Frequency of catch rate occurrence", subtitle = str_c("Distribution of simulated values of spring Atlantic mackerel biomass for each productivity scenario observed in\nstratum", strat, "in", year, sep = " "), fill = "Area of catch\nrate occurrence") + 
  theme(legend.position = "none") + xlim(NA, 0.05) #+ stat_bin(binwidth = 0.0001)

# ggsave("spring_100sim_catchrate-dist3.png", device = "png", last_plot(), here(sim.check.plots), width = 9, height = 6)
```


```{r}
# Differences in the means 
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
# bind_rows(base_diff, inc_diff, dec_diff) |> 
#   ggplot() + 
#   geom_point(aes(x = as.factor(scenario), y = abs_diff_mu)) + 
#   labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in means between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
#   facet_wrap(~season) +
#   theme_bw()
# 
# # to extract exact median values plotted in the boxplot
# median(base_diff$abs_diff_mu)
# median(inc_diff$abs_diff_mu)
# median(dec_diff$abs_diff_mu)


```



```{r}
#  Differences in the cvs 
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
# bind_rows(base_diff, inc_diff, dec_diff) |> 
#   ggplot() + 
#   geom_boxplot(aes(x = as.factor(scenario), y = abs_diff_cv)) + 
#   labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in the CVs between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
#   facet_wrap(~season) +
#   theme_bw()
# 
# # to extract exact median values plotted in the boxplot
# median(base_diff$abs_diff_cv)
# median(inc_diff$abs_diff_cv)
# median(dec_diff$abs_diff_cv)


# ggsave("spring_500sim_cv-diff-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)

```
