---
title: "Validate fall summer flounder catch rates"
author: "Angelia Miller"
date: "2024-01-10"
output: word_document
---

## Objective 
* simulate one year and 500 replicates of the two treatments and control in one wind-overlapped strata
* plot the distribution of catch rates for each scenario 

```{r load packages}
# library(stringr)
# library(sf)
# library(patchwork)
library(here)
suppressPackageStartupMessages(library(tidyverse))
library(sdmTMB) 
library(nationalparkcolors)
# source(here("R", "StratMeanFXs_v2.R"))

pal <- park_palette("Badlands")
sumflounder.dat <- here("sdmtmb", "sumflounder", "data")
sim.check <- here("sdmtmb", "sumflounder", "data", "simulations", "sim-checking")
sim.check.plots <- here("sdmtmb", "sumflounder", "plots", "simulations", "sim-checking")
```

### Data set up
Load in the model fitting data, fitted model, and the model predictions 
```{r load data}
# model fitting data 
sf_fall <- readRDS(here(sumflounder.dat, "sumflounder_fall.rds"))

# model fitting mesh 
#mesh <- readRDS(here(sumflounder.dat, "fall_mesh.rds"))

# polynomial coefficients from fall model fit extracted in "02a-check-fall-sim.Rmd"
fall_depth_coefs <- readRDS(here(sim.check, "fall_depth_coefs.rds"))

# fall summer flounder model 
fall_mod <- readRDS(here(sumflounder.dat, "fall_mod.rds"))

# fall model predictions 
fall_preds <- readRDS(here(sumflounder.dat, "fall_mod_preds.rds")) |> 
  select(X, Y, STATION, CRUISE6, STRATUM, omega_s, ) |> 
  rename(fix_omegas = omega_s)


```

Generate a random set of numbers for the number of iterations that will be produced in the simulation to use as the set seed argument for reproducibility. 
Then find the number of wind tows in each strata and year and the total proportion those tows make up of the overall tows observed in that year and strata. From here we want to select a strata and year that have ~50% proportion of wind tows, and where the observations of biomass in those tows are of equal magnitude to those observations of biomass that occurred in outside tows. 
```{r number generation}
set.seed(72346)

# generate 3000 random numbers and sample for 500 to set seed with each iteration of sdmTMB_simulate for reproducibility
seed.num.gen <- round(rnorm(3000, mean = 1305700, sd = 10000), 0)
seed.num <- sample(seed.num.gen, size = 100, replace = FALSE)
# length(which(duplicated(seed.num) == TRUE))

# identify which year and stratum has the most wind tows
wind_tows <- sf_fall |> 
  filter(AREA == "WIND") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
outside_tows <- sf_fall |> 
  filter(AREA == "OUTSIDE") |> 
  group_by(EST_YEAR, STRATUM) |> 
  summarise(count = length(unique(TOWID))) |> 
  arrange(desc(count))
left_join(outside_tows, wind_tows, by = c("EST_YEAR", "STRATUM")) |> janitor::clean_names() |> 
  mutate(prop = count_y / (count_x + count_y)) |> 
  arrange(desc(prop))

```

Set the year and strata to filter the model fitted data and predictions by to create a new dataset of locations that will be used to simulate values of biomass at. 
```{r data wrangle}
# year <- 2018
# strat <- 3200

# join prediction data to model fitting data to add predicted spatial estimate for data simulation
sf_fall <-   sf_fall |> 
  left_join(fall_preds, by = c("X", "Y", "STATION", "STRATUM", "CRUISE6")) #|> 
  #filter(EST_YEAR == year, STRATUM == strat) |> 
  #mutate(EST_YEAR = 1)

sf_fall_info <- sf_fall |>
  dplyr::select(X, Y, EST_YEAR, STRATUM, CRUISE6, STATION, AREA, AREA_CODE, SEASON) |> 
  mutate(AREA_CODE = ifelse(AREA == "OUTSIDE", 0, AREA_CODE))

# mesh for simulating
mesh <- make_mesh(sf_fall, xy_cols = c("X", "Y"), cutoff = 10)

# pull main effect parameters from fall model fit
fall_coefs <- tidy(fall_mod) 

# pull random effect parameters from fall model fit
fall_ran_pars <- tidy(fall_mod, "ran_pars")


fall_coefs
fall_ran_pars

```







## Simulate Scenarios 
Set the b argument by extracting the coefficients for the depth effects, the selected year, and the area effect with and without the intended treatment effects. Remove the intercept value by setting its coefficient to 0, and fix the predicted spatial effect from the model by setting its coefficient to 1 and removing the `sigma_O` argument from the simulation.

### Base 
```{r sim base}
# b <- c(0, fall_coefs$estimate[1:2], fall_coefs$estimate[10],
#        fall_coefs$estimate[14], 1)
b <- c(fall_coefs$estimate, 1)

fall.base <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1 + 
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = sf_fall,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = fall_ran_pars$estimate[1], 
    sigma_O = 0,
    sigma_E = fall_ran_pars$estimate[4],
    phi = fall_ran_pars$estimate[2],
    tweedie_p = fall_ran_pars$estimate[5],
    seed = .y)
)

head(fall.base)
# saveRDS(fall.base, here(sim.check, "fall_base-100sim.rds"))


```

### Enhanced
```{r sim increase}
# b <- c(0, fall_coefs$estimate[1:2], fall_coefs$estimate[10],
       # (fall_coefs$estimate[14]+log(2)), 1)
b <- c(fall_coefs$estimate[1:13], (fall_coefs$estimate[14]+log(2)), 1)

fall.inc <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1 +
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = sf_fall,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = fall_ran_pars$estimate[1], 
    sigma_O = 0,
    sigma_E = fall_ran_pars$estimate[4],
    phi = fall_ran_pars$estimate[2],
    tweedie_p = fall_ran_pars$estimate[5],
    seed = .y)
)

head(fall.inc)
# saveRDS(fall.inc, here(sim.check, "fall_inc-100sim.rds"))
```

### Reduced
```{r sim decrease}
# b <- c(0, fall_coefs$estimate[1:2], fall_coefs$estimate[10],
#        (fall_coefs$estimate[14]-log(2)), 1)
b <- c(fall_coefs$estimate[1:13],
       (fall_coefs$estimate[14]-log(2)), 1)

fall.dec <- map2(1:100, seed.num, ~sdmTMB_simulate(
    formula = ~#1+ 
      poly(AVGDEPTH, 2, coefs = fall_depth_coefs) +
      as.factor(EST_YEAR) +
      as.factor(AREA) +
      fix_omegas - 1,
    data = sf_fall,
    mesh = mesh,
    family = tweedie(),
    #spatial = "on",
    time = "EST_YEAR",
    spatiotemporal = "IID",
    B = b,
    range = fall_ran_pars$estimate[1], 
    sigma_O = 0,
    sigma_E = fall_ran_pars$estimate[4],
    phi = fall_ran_pars$estimate[2],
    tweedie_p = fall_ran_pars$estimate[5],
    seed = .y)
)

head(fall.dec)
# saveRDS(fall.dec, here(sim.check, "fall_dec-100sim.rds"))
```


## Data wrangle 
Create one large dataframe from each productivity simulation based on simulated iteration. 

```{r}
# year and stratum to filter for 
year <- 2018
strat <- 3200

# Baseline
fall.base.df <- map(fall.base, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Baseline", 
         season = "Fall") |> 
  left_join(sf_fall_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)

# Enhanced 
fall.inc.df <- map(fall.inc, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Enhanced", 
         season = "Fall") |> 
  left_join(sf_fall_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)

# Reduced
fall.dec.df <- map(fall.dec, ~janitor::clean_names(.)) |> 
  map2_dfr(1:100, ~mutate(.x, sim = .y)) |> 
  mutate(scenario = "Reduced", 
         season = "Fall") |> 
 left_join(sf_fall_info, by = join_by(x == X, y == Y, est_year == EST_YEAR, as_factor_area_wind == AREA_CODE)) |> 
  filter(est_year == year, STRATUM == strat) |> 
  dplyr::select(est_year, x, y, STRATUM, STATION, CRUISE6, observed, sim, scenario, season, AREA, as_factor_area_wind)

```


```{r}
# calculate the "status quo" scenario
# fall_base_ww <- filtered.base.df |> 
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Baseline")
# 
# # calculate the "precluded" scenario
# fall_base_wow <- filtered.base.df |> 
#   filter(as_factor_area_wind == 0) |> #outside areas
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Baseline")
# 
# # bind the scenarios to calculate the absolute percent difference
# base_diff <- left_join(fall_base_ww, fall_base_wow, by = c("sim", "scenario")) |>
#   janitor::clean_names() |>
#   group_by(sim) |> #, est_year) |>
#  summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
#             abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
#   mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
#          abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
#          scenario = "Baseline", 
#          season = "Fall")

# saveRDS(fall_base_ww, here(sim.check, "fall_base_ww-500sim.rds"))
# saveRDS(fall_base_wow, here(sim.check, "fall_base_wow-500sim.rds"))
# saveRDS(base_diff, here(sim.check, "fall_base_diff-500sim.rds"))
  
```


```{r}
# calculate the "status quo" scenario
# fall_inc_ww <- filtered.inc.df |> 
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Enhanced")
#   
# # calculate the "precluded" scenario
# fall_inc_wow <- filtered.inc.df |> 
#   filter(as_factor_area_wind == 0) |> #outside areas
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Enhanced")
# 
# # bind the scenarios to calculate the absolute percent difference
# inc_diff <- left_join(fall_inc_ww, fall_inc_wow, by = c("sim", "scenario")) |>
#   janitor::clean_names() |>
#   group_by(sim) |> #, est_year) |>
#   summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
#             abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
#   mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
#          abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
#          scenario = "Enhanced", 
#          season = "Fall")

# saveRDS(fall_inc_ww, here(sim.check, "fall_inc_ww-500sim.rds"))
# saveRDS(fall_inc_wow, here(sim.check, "fall_inc_wow-500sim.rds"))
# saveRDS(inc_diff, here(sim.check, "fall_inc_diff-500sim.rds"))

```


```{r}

# calculate the "status quo" scenario
# fall_dec_ww <- filtered.dec.df |> 
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Reduced")
#   
# # calculate the "precluded" scenario
# fall_dec_wow <- filtered.dec.df |> 
#   filter(as_factor_area_wind == 0) |> #outside areas
#   group_by(sim) |> 
#   summarise(mu = mean(observed), 
#             var = var(observed), 
#             cv = sqrt(var)/mu) |> 
#   mutate(scenario = "Reduced")
# 
# # bind the scenarios to calculate the absolute percent difference
# dec_diff <- left_join(fall_dec_ww, fall_dec_wow, by = c("sim", "scenario")) |>
#   janitor::clean_names() |>
#   group_by(sim) |> #, est_year) |>
#   summarise(abs_diff_mu =( abs(mu_x - mu_y) / mu_x)*100, 
#             abs_diff_cv =( abs(cv_x - cv_y) / cv_x)*100) |>
#   mutate(abs_diff_mu = ifelse(is.nan(abs_diff_mu), 0, abs_diff_mu),
#          abs_diff_cv = ifelse(is.nan(abs_diff_cv), 0, abs_diff_cv),
#          scenario = "Reduced", 
#          season = "Fall")

# saveRDS(fall_dec_ww, here(sim.check, "fall_dec_ww-500sim.rds"))
# saveRDS(fall_dec_wow, here(sim.check, "fall_dec_wow-500sim.rds"))
# saveRDS(dec_diff, here(sim.check, "fall_dec_diff-500sim.rds"))

```

## Plot distribution of catch rates
```{r}
bind_rows(fall.base.df, fall.inc.df, fall.dec.df) |> 
  #filter(observed > 0) |> 
    ggplot() + 
    geom_col(aes(x = as.factor(scenario), y = observed, fill = as.factor(as_factor_area_wind)), position = position_dodge(width = 0.3), width = 0.25) + 
  scale_fill_manual(values = pal, breaks = c(0, 1), labels = c("Outside Wind", "Inside Wind")) +
  facet_wrap(~season) + 
  labs(x = "Productivity scenario", y = "Simulated values of biomass (kg)", subtitle = str_c("Distribution of simulated values of summer flounder biomass for each productivity scenario observed in\nstratum", strat, "in", year, sep = " "), fill = "Area of catch\nrate occurrence") + 
  theme(legend.position = "bottom")

# ggsave("fall_500sim_catchrate-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)

bind_rows(fall.base.df, fall.inc.df, fall.dec.df) |> 
  #filter(observed > 0) |> 
  ggplot() + 
  geom_histogram(aes(x = observed, fill = AREA)) +
    #scale_x_log10()+
  scale_fill_manual(values = pal) +
  facet_grid(cols = vars(scenario), rows = vars(str_to_title(AREA))) + 
  labs(x = "Catch Rate (kg/tow)", y = "Frequency of catch rate occurrence", subtitle = str_c("Distribution of simulated values of fall summer flounder biomass for each productivity scenario observed in\nstratum", strat, "in", year, sep = " "), fill = "Area of catch\nrate occurrence") + 
  theme(legend.position = "none")

# ggsave("fall_100sim_catchrate-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)
```


```{r}
# Differences of Means 
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
# bind_rows(base_diff, inc_diff, dec_diff) |> 
#   ggplot() + 
#   geom_boxplot(aes(x = as.factor(scenario), y = abs_diff_mu)) + 
#   labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in means between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
#   facet_wrap(~season) +
#   theme_bw()
# 
# # to extract exact median values plotted in the boxplot
# median(base_diff$abs_diff_mu)
# median(inc_diff$abs_diff_mu)
# median(dec_diff$abs_diff_mu)

# ggsave("fall_500sim_mudiff-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)
```


```{r}
# Distribution of CVs
# bind the absolute percent difference dataframes of all three productivity scenarios and plot the distribution of differences 
# bind_rows(base_diff, inc_diff, dec_diff) |> 
#   ggplot() + 
#   geom_boxplot(aes(x = as.factor(scenario), y = abs_diff_cv)) + 
#   labs(x = "Productivity scenario", y = "Absolute percent difference between survey effort scenarios", subtitle = str_c("Distribution of differences in CVs between survey effort scenarios for each productivity scenario\nobserved in stratum", strat, "in", year, "and across 500 replicates", sep = " ")) + 
#   facet_wrap(~season) +
#   theme_bw()
# 
# # to extract exact median values plotted in the boxplot
# median(base_diff$abs_diff_cv)
# median(inc_diff$abs_diff_cv)
# median(dec_diff$abs_diff_cv)

# ggsave("fall_500sim_cv-diff-dist.png", device = "png", last_plot(), here(sim.check.plots), width = 8, height = 6)
```
